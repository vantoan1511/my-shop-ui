<div class="container">
  <div class="row mt-4 bg-white shadow-sm rounded">
    <nav class="col-md-3 col-lg-2 d-md-block p-3 bg-light border-end">
      <div class="position-sticky">
        <div class="d-flex align-items-center gap-3 text-center mb-4">
          <div class="avatar">
            <img [src]="avatarUrl"
                 alt="User Avatar"
                 class="img-fluid"
                 width="48"
                 height="48"/>
          </div>
          <h5 class="username">{{ username }}</h5>
        </div>
        <hr/>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="#profile" data-bs-toggle="tab">
              <i class="bi bi-person me-2"></i>{{ "Profile" | translate }}
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#change-password" data-bs-toggle="tab">
              <i class="bi bi-shield-lock me-2"></i>{{ "Change password" | translate }}
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#orders" data-bs-toggle="tab" (click)="loadOrders()">
              <i class="bi bi-journals me-2"></i>{{ "Orders" | translate }}
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-4">
      <div class="tab-content p-3">
        <div class="tab-pane fade show active" id="profile">
          <span class="fs-3 fw-lighter">{{ "PROFILE INFORMATION" | translate }}</span>
          <hr/>
          <div class="row">
            <div class="profile col-md-8">
              <form [formGroup]="userForm" (ngSubmit)="onProfileFormSubmit()">
                <div class="mb-3 row">
                  <label for="username"
                         class="col-sm-4 col-form-label text-end">
                    {{ "Username" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="username"
                           type="text"
                           class="readonly form-control"
                           id="username"
                           [disabled]="true"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="firstname"
                         class="col-sm-4 col-form-label text-end">
                    {{ "First name" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="firstName"
                           type="text"
                           class="form-control"
                           id="firstname"
                           [placeholder]="'First name' | translate"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="lastname"
                         class="col-sm-4 col-form-label text-end">
                    {{ "Last name" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="lastName"
                           type="text"
                           class="form-control"
                           id="lastname"
                           [placeholder]="'First name' | translate"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="email" class="col-sm-4 col-form-label text-end">
                    {{ "Email" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="email"
                           type="email"
                           class="form-control"
                           id="email"
                           placeholder="Email"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="phone" class="col-sm-4 col-form-label text-end">
                    {{ "Phone number" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="phone"
                           type="tel"
                           class="form-control"
                           id="phone"
                           [placeholder]="'Phone number' | translate"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="address" class="col-sm-4 col-form-label text-end">
                    {{ "Address" | translate }} ({{ "Default" | translate }})
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="address"
                           type="text"
                           class="form-control"
                           id="address"
                           [placeholder]="'Address' | translate"
                           required/>
                  </div>
                </div>
                @for (i of [1, 2, 3, 4]; track i) {
                  <div class="mb-3 row">
                    <label [for]="'address'+i" class="col-sm-4 col-form-label text-end">
                      {{ "Address" | translate }} {{ i }}
                    </label>
                    <div class="col-sm-8">
                      <input [formControlName]="'address'+i"
                             type="text"
                             class="form-control"
                             [id]="'address'+i"
                             [placeholder]="'Address'+i"/>
                    </div>
                  </div>
                }
                <div class="mb-3 row">
                  <label for="gender" class="col-sm-4 col-form-label text-end">
                    {{ "Gender" | translate }}
                  </label>
                  <div id="gender" class="col-sm-8 col-form-label">
                    <div class="form-check form-check-inline">
                      <input formControlName="gender"
                             class="form-check-input"
                             type="radio"
                             value="MALE"
                             id="male"/>
                      <label class="form-check-label"
                             for="male"> {{ "Male" | translate }} </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input formControlName="gender"
                             class="form-check-input"
                             type="radio"
                             id="female"
                             value="FEMALE"/>
                      <label class="form-check-label" for="female">
                        {{ "Female" | translate }}
                      </label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input formControlName="gender"
                             class="form-check-input"
                             type="radio"
                             id="other"
                             value="UNKNOWN"/>
                      <label class="form-check-label" for="other">
                        {{ "Other" | translate }}
                      </label>
                    </div>
                  </div>
                </div>
                <div class="mb-3 row">
                  <div class="col-sm-4"></div>
                  <div class="col-sm-8">
                    <button [disabled]="!isValidProfileForm || !dirtyProfileForm"
                            type="submit"
                            class="btn btn-primary">
                      {{ "Save" | translate }}
                    </button>
                  </div>
                </div>
              </form>
            </div>
            <div class="col-md-4">
              <div class="d-flex flex-column justify-content-center align-items-center">
                <input type="file"
                       class="d-none"
                       id="avatar"
                       accept="image/jpeg, image/png"
                       (change)="previewImage($event)"/>
                <label for="avatar"
                       class="text-center mb-3"
                       style="cursor: pointer">
                  <div class="avatar-preview rounded-circle">
                    <img id="avatar-preview"
                         [src]="avatarUrl"
                         alt="Avatar Preview"/>
                  </div>
                </label>
                <div class="helper-text text-muted fs-6">
                  <span>{{ "File size limit" | translate }}: 1MB. {{ "Accepted format" | translate }}: PNG, JPG.</span>
                </div>
              </div>
              <hr/>
              <div class="row">
                <div class="helper-text text-muted fs-6">
                  <span>{{ "Or choose from uploaded" | translate }}.</span>
                </div>
                <div class="gallery row row-cols-md-2 g-2 overflow-auto"
                     (scroll)="onScrollGallery($event)">
                  @for (image of uploaded?.items; track $index) {
                    <div class="col">
                      <div class="card">
                        <img [src]="createImageUrl(image.id)"
                             class="card-img-top"
                             [alt]="image.altText"
                             (click)="setAvatar(image)">
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="change-password">
          <span class="fs-3 fw-lighter">{{ "Change password" | translate }}</span>
          <hr/>
          <div class="row">
            <div class="col-md-8">
              <form [formGroup]="passwordForm"
                    (ngSubmit)="onPasswordFormSubmit()">
                <div class="mb-3 row">
                  <label for="password"
                         class="col-sm-4 col-form-label text-end">
                    {{ "New password" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input formControlName="password"
                           type="password"
                           class="form-control"
                           id="password"
                           [placeholder]="'Enter your new password' | translate"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <label for="re-password"
                         class="col-sm-4 col-form-label text-end">
                    {{ "Confirm password" | translate }}
                  </label>
                  <div class="col-sm-8">
                    <input [class.ng-invalid]="this.notMatchedPassword"
                           formControlName="rePassword"
                           type="password"
                           class="form-control"
                           id="re-password"
                           [placeholder]="'Confirm new password' | translate"/>
                  </div>
                </div>
                <div class="mb-3 row">
                  <div class="col-sm-4"></div>
                  <div class="col-sm-8">
                    <button [disabled]="passwordForm.invalid || !passwordForm.dirty"
                            type="submit"
                            class="btn btn-primary">
                      {{ "Save" | translate }}
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="orders">
          <span class="fs-3 fw-lighter">{{ "Your Orders" | translate }}</span>
          <hr/>
          <div class="row">
            <!-- Order List on the Left -->
            <div class="col-lg-4 col-md-5">
              <ul class="list-group mb-4">
                @for (order of orders; track $index) {
                  <li class="list-group-item d-flex justify-content-between align-items-center"
                      [class.active]="selectedOrder === order"
                      (click)="viewOrderDetails(order)">
                    <div>
                      <h6 class="mb-1">#{{ order.id }}</h6>
                      <small class="text-muted me-2">{{ order.createdAt | date:"HH:mm dd-MM-yyyy" }}</small>
                    </div>
                    <span class="badge bg-primary mt-2">{{ order.orderStatus | translate }}</span>
                  </li>
                }
              </ul>
            </div>

            <!-- Order Details on the Right -->
            @if (selectedOrder) {
              <div class="col-lg-8 col-md-7">
                <div class="card shadow-sm">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="fs-5 fw-light text-muted">
                      {{ "Order Summary" | translate }}  - #{{ selectedOrder.id }}
                    </h6>
                    <button class="btn close-detail-btn btn-sm" (click)="selectedOrder = null">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>

                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <p class="mb-0">
                          <span class="fw-light text-muted">{{ "Order Date" | translate }}:</span>
                          {{ selectedOrder.createdAt | date:"HH:mm dd-MM-yyyy" }}
                        </p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-0">
                          <span class="fw-light text-muted">{{ "Total Amount" | translate }}:</span>
                          {{ selectedOrder.totalAmount | currency: "VND" }}
                        </p>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <p class="mb-0">
                          <span class="fw-light text-muted">{{ "Payment method" | translate }}:</span>
                          {{ selectedOrder.paymentMethod }}
                        </p>
                      </div>
                      <div class="col-md-6">
                        <p class="mb-0 text-wrap">
                          <span class="fw-light text-muted">{{ "Shipping address" | translate }}:</span>
                          {{ selectedOrder.shippingAddress }}
                        </p>
                      </div>
                    </div>

                    <hr/>
                    <ul class="list-group">
                      @for (item of orderDetails.get(selectedOrder.id); track $index) {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                          <div>
                            <a [routerLink]="['/may-tinh-xach-tay', item.productSlug]"
                               class="text-uppercase fw-bold text-muted product-slug">
                              {{ item.productSlug }}
                            </a>
                            <small class="text-muted d-block">{{ item.quantity }}
                              x {{ item.price | currency:"VND" }}</small>
                          </div>
                          <span>{{ item.quantity * item.price | currency:"VND" }}</span>
                        </li>
                      }

                    </ul>

                    <div class="d-flex justify-content-end mt-4">
                      <button class="btn cancel-order-btn me-2"
                              (click)="cancelOrder(selectedOrder)">
                        {{ "Cancel order" | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            }
          </div>
          @if (orderResponse?.hasNext) {
            <div class="text-center">
              <button class="btn load-more-order-btn" (click)="loadOrders()">{{ 'Load more' | translate }}</button>
            </div>
          }
        </div>
      </div>
    </main>
  </div>
</div>
